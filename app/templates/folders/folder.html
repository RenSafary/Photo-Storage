<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/static/css/folders/current_folder.css" rel="stylesheet">
  <title>PS | {{ folder }}</title>
</head>
<body>
  <header class="header-nav">
    <a href="/gallery/folders/{{user}}/{{folder}}/delete_folder" class="delete_btn">DELETE</a>
    <a href="/gallery" class="nav-btn">GALLERY</a>
    <a href="/gallery/folders/" class="nav-btn">FOLDERS</a>
    <button class="add-existing-btn" onclick="openUploadPopup()">ADD</button>
  </header>

  <!-- попап выбора файлов -->
  <div id="uploadPopup" class="popup" onclick="closePopup('uploadPopup')">
    <div class="popup-content" onclick="event.stopPropagation()">
      <div class="popup-header">
        <h3 class="popup-title">Select Files to Add</h3>
        <button class="close-popup" onclick="closePopup('uploadPopup')">&times;</button>
      </div>
      <div class="file-selector-grid" id="fileSelectorGrid"></div>
      <div class="popup-actions">
        <button class="popup-btn secondary" onclick="closePopup('uploadPopup')">Cancel</button>
        <button class="popup-btn primary" onclick="addSelectedFiles()">Add Selected Files</button>
      </div>
    </div>
  </div>

  <!-- список файлов -->
  <main class="main-content">
    <div class="files-grid">
      {% if all_files_by_folder_id %}
        {% for file in all_files_by_folder_id %}
          <div class="file-item">
            {% if file.key.lower().endswith(('.jpg', '.png', '.gif', '.jpeg')) %}
              <img src="{{file.url}}" alt="{{file.key}}" class="file-thumbnail" onclick="openImagePopup('{{file.url}}')">
              <p class="file-info">{{file.key.split('/')[-1]}}</p>
              <a href="/gallery/folders/{{user}}/{{file.folder_id}}/delete_file/"
                 class="delete-btn">Delete</a>
            {% elif file.key.lower().endswith(('.mp4', '.mov')) %}
              <video controls class="file-thumbnail">
                <source src="{{file.url}}" type="video/mp4">
              </video>
              <p class="file-info">{{file.key.split('/')[-1]}}</p>
              <a href="/gallery/folders/{{user}}/{{folder}}/delete_file/{{file.id}}"
                 class="delete-btn"
                 onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p class="empty-message">There are no photos or videos in this folder yet.</p>
      {% endif %}
    </div>
  </main>

  <!-- попап просмотра картинки -->
  <div id="imagePopup" class="popup" onclick="closePopup('imagePopup')">
    <span class="close-btn" onclick="closePopup('imagePopup', event)">&times;</span>
    <img class="popup-content" id="popupImage">
  </div>

  <!-- форма для отправки выбранных файлов -->
  <form class="upload-form" method="POST" action="/gallery/folders/{{user}}/{{folder}}/upload_in_folder">
  </form>

  <script>
    const all_files = {{ all_files|tojson }};
    let selectedFiles = [];

    function openUploadPopup() {
      document.getElementById('uploadPopup').style.display = 'flex';
      loadFiles();
    }

    function closePopup(popupId) {
      document.getElementById(popupId).style.display = 'none';
      if (popupId === 'uploadPopup') {
        document.getElementById('fileSelectorGrid').innerHTML = "";
        selectedFiles = [];
      }
    }

    function loadFiles() {
      const grid = document.getElementById('fileSelectorGrid');
      grid.innerHTML = "";

      all_files.forEach(file => {
        const box = document.createElement('div');
        box.className = 'file-option';

        let preview = "";
        if (file.key.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) {
          preview = `<img src="${file.url}" class="file-thumbnail" style="max-width:100px;max-height:100px;display:block;margin:auto;">`;
        } else if (file.key.toLowerCase().match(/\.(mp4|mov)$/)) {
          preview = `<video class="file-thumbnail" style="max-width:100px;max-height:100px;display:block;margin:auto;" muted>
                      <source src="${file.url}" type="video/mp4">
                     </video>`;
        } else {
          preview = `<div class="file-icon-placeholder"></div>`;
        }

        box.innerHTML = `
          ${preview}
          <div>
            <input type="checkbox" id="file_${file.id}" value="${file.id}" onchange="toggleFileSelection('${file.id}')">
            <label for="file_${file.id}">${file.key.split('/').pop()}</label>
          </div>
        `;
        grid.appendChild(box);
      });
    }

    function toggleFileSelection(fileId) {
      const idx = selectedFiles.indexOf(fileId);
      if (idx > -1) selectedFiles.splice(idx, 1);
      else selectedFiles.push(fileId);
    }

    function addSelectedFiles() {
      if (selectedFiles.length === 0) {
        alert("Please select at least one file.");
        return;
      }

      const form = document.querySelector('.upload-form');

      // убрать старые инпуты
      document.querySelectorAll('input[name="existing_file_ids"]').forEach(el => el.remove());

      selectedFiles.forEach(id => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'existing_file_ids';
        hidden.value = id;
        form.appendChild(hidden);
      });

      form.submit();
    }

    function openImagePopup(url) {
      const popup = document.getElementById("imagePopup");
      const popupImage = document.getElementById("popupImage");
      popup.style.display = "flex";
      popupImage.src = url;
    }
  </script>
</body>
</html>
